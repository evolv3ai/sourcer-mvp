# Story 1.2: Display Webcam Feed

## Status: Approved

## Story

-   As an AI Enthusiast,
-   I want to see a live feed from my default webcam within the application,
-   so that I know what the application is "seeing".

## Acceptance Criteria (ACs)

1.  The application automatically attempts to detect and use the default system webcam upon launch or when the webcam display area becomes visible.
2.  Live video from the webcam is displayed clearly in the designated `WebcamDisplayWidget` area.
3.  The video feed is reasonably smooth (e.g., target >10 FPS, actual target to be confirmed by Architect based on typical hardware and processing overhead).
4.  If no webcam is found or if access is denied by the OS/user, a user-friendly message (e.g., "Webcam not detected or access denied. Please check your webcam settings.") is displayed within the `WebcamDisplayWidget` area.
5.  The webcam capture process runs on a separate thread to avoid freezing the PyQt UI.

## Tasks / Subtasks

-   [ ] **Task 1: Implement `VideoService` for Webcam Capture (AC: 1, 5)**
    -   [ ] Create/Update `src/sourcer/services/video_service.py`.
    -   [ ] Define a `VideoService` class.
    -   [ ] Implement a method to initialize webcam capture using `OpenCV-Python` (e.g., `cv2.VideoCapture(0)` for default webcam).
    -   [ ] Implement a method (`start_capture`) to run the frame grabbing loop in a separate `QThread`. This thread will continuously read frames from the webcam.
    -   [ ] Implement a mechanism (e.g., a Qt signal `new_frame_ready(frame: FrameData)`) within `VideoService` or its thread to emit new frames.
    -   [ ] Implement methods to `stop_capture` and release webcam resources gracefully.
    -   [ ] Handle potential errors during webcam initialization (e.g., webcam not found, permission issues) and report them (e.g., via a status signal or exception).
-   [ ] **Task 2: Implement `WebcamDisplayWidget` (AC: 2, 4, 5)**
    -   [ ] Create/Update `src/sourcer/ui/widgets/webcam_widget.py`.
    -   [ ] Define a `WebcamDisplayWidget` class (e.g., inheriting `QWidget` or `QLabel`).
    -   [ ] Implement a Qt slot (e.g., `update_frame(frame: FrameData)`) to receive `FrameData` (likely a NumPy array from OpenCV).
    -   [ ] Convert the `FrameData` (e.g., BGR OpenCV frame) to a `QImage` or `QPixmap` suitable for display in a PyQt widget.
    -   [ ] Display the `QImage`/`QPixmap` in the widget. Ensure it scales appropriately within the widget's boundaries while maintaining aspect ratio.
    -   [ ] Implement logic to display the error message (e.g., "Webcam not detected...") if the `VideoService` reports an error or if no frames are received.
-   [ ] **Task 3: Integrate `VideoService` and `WebcamDisplayWidget` into `MainWindow` (AC: 1, 2, 3)**
    -   [ ] In `src/sourcer/ui/main_window.py` (or `app.py` as appropriate for service instantiation):
        -   [ ] Instantiate the `VideoService`.
        -   [ ] Instantiate the `WebcamDisplayWidget` (replacing the placeholder from Story 1.1).
        -   [ ] Connect the `VideoService.new_frame_ready` signal to the `WebcamDisplayWidget.update_frame` slot.
        -   [ ] Add the functional `WebcamDisplayWidget` to the main window's layout in the designated area.
        -   [ ] Initiate webcam capture via `VideoService.start_capture()` when the `MainWindow` is shown or initialized.
        -   [ ] Ensure `VideoService.stop_capture()` is called when the application is closing.
-   [ ] **Task 4: Implement Frame Rate Monitoring (Internal for AC:3)**
    -   [ ] (For developer validation) Add a simple internal mechanism or logging to check the frame rate of the displayed video to ensure it meets the smoothness criteria (target >10 FPS). This is not necessarily a user-visible feature.

## Dev Technical Guidance

-   **Webcam Capture:** Use `OpenCV-Python` (`cv2`) for accessing and reading frames from the webcam. `cv2.VideoCapture(0)` usually accesses the default webcam.
-   **Threading:** Webcam frame capture and processing (`VideoService`) **must** run in a separate `QThread` to prevent the UI from freezing. Use Qt signals and slots for safe communication between the `VideoService` thread and the main UI thread (e.g., for sending new frames to `WebcamDisplayWidget`).
-   **Frame Conversion:** Frames captured by OpenCV are typically NumPy arrays (often in BGR format). These need to be converted to `QImage` or `QPixmap` for display in PyQt. Pay attention to color channel order (BGR to RGB) and image format (`QImage.Format_RGB888` or similar).
    ```python
    # Example conversion snippet (inside WebcamDisplayWidget or a utility)
    # import cv2
    # from PyQt6.QtGui import QImage, QPixmap
    # from PyQt6.QtCore import Qt

    # def convert_cv_qt(cv_img):
    #     """Convert an opencv image to QPixmap"""
    #     rgb_image = cv2.cvtColor(cv_img, cv2.COLOR_BGR2RGB)
    #     h, w, ch = rgb_image.shape
    #     bytes_per_line = ch * w
    #     convert_to_Qt_format = QImage(rgb_image.data, w, h, bytes_per_line, QImage.Format.Format_RGB888)
    #     # Potentially scale it:
    #     # p = convert_to_Qt_format.scaled(display_width, display_height, Qt.AspectRatioMode.KeepAspectRatio)
    #     return QPixmap.fromImage(convert_to_Qt_format)
    ```
-   **Error Handling:** The `VideoService` should robustly handle cases where the webcam is not available or permissions are denied, and communicate this status to the UI layer. The `WebcamDisplayWidget` should then display the appropriate user-friendly message.
-   **Resource Management:** Ensure the webcam is properly released (`cv2.VideoCapture.release()`) when the application closes or the `VideoService` is stopped to free up the resource.
-   **UI Integration:** Replace the placeholder for the webcam display area created in Story 1.1 with the functional `WebcamDisplayWidget`.
-   **Performance:** Monitor the smoothness of the video. If >10 FPS is not met, initial investigation into bottlenecks (capture speed, frame conversion, rendering) will be needed.

## Story Progress Notes

### Agent Model Used: `<Agent Model Name/Version>`

### Completion Notes List
{Any notes about implementation choices, difficulties, or follow-up needed}

### Change Log