# Story 6.1: Create Windows Installer Package

## Status: Approved

## Story

-   As an AI Early Adopter,
-   I want a simple way to install Sourcer on my Windows machine,
-   so that I can start using it quickly.

## Acceptance Criteria (ACs)

1.  A script is created (e.g., `scripts/build_installer.py` or a shell script) that automates the process of bundling the application using PyInstaller and then creating an installer using Inno Setup.
2.  PyInstaller successfully bundles the Sourcer Python application (`src/sourcer/main.py` and all its dependencies from `requirements.txt`) into a standalone executable or directory for Windows.
3.  All necessary local AI models (YOLO, SAM, LLaVA, STT, TTS models from the `models/` directory) and assets (e.g., `assets/icons/app_icon.png`) are correctly included in the PyInstaller bundle or are packaged by Inno Setup to be placed correctly relative to the executable.
4.  Inno Setup uses the PyInstaller output to create a single `.exe` installer file for Windows 10/11.
5.  Running the generated `.exe` installer on a clean Windows 10/11 machine successfully installs the Sourcer application to a standard location (e.g., `C:\Program Files\SourcerMVP` or `C:\Users\[User]\AppData\Local\Programs\SourcerMVP`).
6.  The installation process creates a Start Menu entry and an optional Desktop shortcut for launching Sourcer, using `assets/icons/app_icon.png`.
7.  After installation, the application can be launched using the created shortcuts and is fully functional (core features from Epics 1-5 work as expected).
8.  The installer provides a standard uninstallation option through Windows "Add or remove programs," which cleanly removes the application and its created files/shortcuts.
9.  The CI/CD pipeline (GitHub Actions) is updated to include a step that runs the installer build script upon tagging a release (e.g., `v0.1.0`), and attaches the generated `.exe` installer as a release artifact.

## Tasks / Subtasks

-   [ ] **Task 1: Configure PyInstaller for Bundling (AC: 2, 3)**
    -   [ ] Create a PyInstaller spec file (e.g., `sourcer.spec`) or configure PyInstaller command-line arguments.
    -   [ ] Ensure `src/sourcer/main.py` is specified as the entry point.
    -   [ ] Configure PyInstaller to include all Python dependencies, non-Python data files (e.g., from Pipecat if any), the `config/settings.ini` file, and the `assets/` directory.
    -   [ ] Crucially, ensure all local AI model files from the `models/` directory (YOLO, SAM, LLaVA, Vosk STT, Piper TTS) are correctly bundled or copied to the output directory so the executable can find them. This might involve PyInstaller's `--add-data` option or custom hooks if models are in complex structures.
    -   [ ] Test running the bundled application directly from PyInstaller's output directory (`dist/sourcer`) to ensure it works before creating the Inno Setup installer.
-   [ ] **Task 2: Create Inno Setup Script (AC: 4, 5, 6, 8)**
    -   [ ] Create an Inno Setup script file (e.g., `sourcer_setup.iss`).
    -   [ ] Configure the script with application details: AppName, AppVersion (can be parameterized), Publisher, AppExeName (from PyInstaller output), default installation directory.
    -   [ ] Specify files to be included: the entire output of PyInstaller (the bundled application directory).
    -   [ ] Define tasks for creating Start Menu shortcuts and an optional Desktop shortcut, using `assets/icons/app_icon.png`.
    -   [ ] Ensure the script correctly sets up the uninstaller information for "Add or remove programs".
    -   [ ] Compile the Inno Setup script to generate the `.exe` installer.
-   [ ] **Task 3: Create Master Build Script (AC: 1)**
    -   [ ] Create a master script (e.g., `scripts/build_installer.sh` or `.py`) that:
        -   [ ] (Optional) Cleans previous build artifacts.
        -   [ ] Runs PyInstaller to bundle the application.
        -   [ ] Runs Inno Setup Compiler (ISCC.exe) with the `.iss` script to create the final installer.
        -   [ ] Places the final installer `.exe` in a designated output directory (e.g., `release/`).
-   [ ] **Task 4: Test Installation and Uninstallation (AC: 5, 7, 8)**
    -   [ ] On a clean Windows 10/11 test environment (e.g., a virtual machine):
        -   [ ] Run the generated `.exe` installer.
        -   [ ] Verify successful installation to the expected directory.
        -   [ ] Verify shortcut creation.
        -   [ ] Launch the application from the shortcut and test core functionalities (webcam display, voice query, text query, TTS response, chat log updates).
        -   [ ] Test the uninstallation process via "Add or remove programs" and verify clean removal of application files and shortcuts.
-   [ ] **Task 5: Update CI/CD Pipeline for Release Builds (AC: 9)**
    -   [ ] Modify `.github/workflows/main.yml`.
    -   [ ] Add a new job or steps that trigger on tagging a release (e.g., `on: release: types: [created]`).
    -   [ ] This job should:
        -   [ ] Checkout the code at the tagged commit.
        -   [ ] Set up Python and install dependencies.
        -   [ ] (If Windows runner is used) Install Inno Setup.
        -   [ ] Run the master build script (`scripts/build_installer.sh` or equivalent) to generate the installer.
        -   [ ] Use an action (e.g., `actions/upload-release-asset`) to upload the generated `.exe` installer to the GitHub Release artifacts.

## Dev Technical Guidance

-   **PyInstaller:**
    -   Use the `--onefile` option if a single executable is desired, but be aware it can lead to slower startup. A one-directory bundle (`--onedir`) is often more robust for complex applications with many data files (like AI models). The choice should prioritize reliability and inclusion of all necessary files.
    -   The `--add-data` flag is critical for non-code files like models and assets. Syntax is `source:destination_in_bundle`.
    -   Test thoroughly to ensure all hidden imports or dynamic dependencies are caught. A spec file offers more control than command-line options alone.
-   **Inno Setup:**
    -   Refer to Inno Setup documentation for script syntax. Key sections: `[Setup]`, `[Files]`, `[Icons]`, `[Run]`, `[UninstallDelete]`.
    -   Ensure the `[Files]` section correctly captures all output from PyInstaller.
    -   Consider user privileges; typically, installation to `Program Files` requires admin rights.
-   **AI Models:** This is the trickiest part. Models are large and must be co-located correctly with the bundled application. The `VideoService`, `STTService`, `TTSService` (and underlying model wrappers) must be able to find these models based on paths relative to the executable or a configurable base path that works post-installation. PyInstaller's `sys._MEIPASS` can be useful for finding bundled files at runtime if using one-file mode, but care is needed.
-   **CI/CD Runner:** Building a Windows installer typically requires a Windows runner in GitHub Actions (`runs-on: windows-latest`). Inno Setup needs to be available on the runner (can be installed via Chocolatey or downloaded).
-   **Version Numbering:** The installer and application version should be consistent. This can be managed via a version file in the source code, read by `setup.py` (if used), PyInstaller, and the Inno Setup script.

## Story Progress Notes

### Agent Model Used: `<Agent Model Name/Version>`

### Completion Notes List
{Any notes about implementation choices, difficulties, or follow-up needed}

### Change Log